import os
from dotenv import load_dotenv
# Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ: openai Ø¨Ù‡ Ø¬Ø§ÛŒ sambanova
from openai import OpenAI 
from datetime import datetime
import pytz

load_dotenv()

# Ú©Ù„ÛŒØ¯ API Ùˆ URL Ú¯Ù¾ Ø¬ÛŒâ€ŒÙ¾ÛŒâ€ŒØªÛŒ
GAPGPT_API_KEY = os.getenv("GAPGPT_API_KEY")
GAPGPT_BASE_URL = os.getenv("GAPGPT_BASE_URL", "https://api.gapgpt.app/v1") 

client = None
SETUP_ERROR = None
# Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ø¯Ù„ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ grok-3-mini
MODEL_NAME = 'grok-3-mini' 

if not GAPGPT_API_KEY:
    print("âš ï¸ Ø®Ø·Ø§: Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ GAPGPT_API_KEY ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!")
    SETUP_ERROR = "Ú©Ù„ÛŒØ¯ API (GAPGPT_API_KEY) ÛŒØ§ÙØª Ù†Ø´Ø¯."
else:
    try:
        # Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø¨Ù‡ Ú©Ù„Ø§ÛŒÙ†Øª OpenAI Ø¨Ø§ URL Ùˆ Ú©Ù„ÛŒØ¯ Ú¯Ù¾ Ø¬ÛŒâ€ŒÙ¾ÛŒâ€ŒØªÛŒ
        client = OpenAI(
            api_key=GAPGPT_API_KEY,
            base_url=GAPGPT_BASE_URL,
        )
        print("âœ… GapGPT API initialized successfully.")
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… GapGPT API: {str(e)}")
        SETUP_ERROR = f"Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø¯Ù„: {str(e)}"

# System Instruction
SYSTEM_INSTRUCTION = """ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ØŒ Ø¯Ù„Ø³ÙˆØ² Ùˆ Ø®ÙˆØ´â€ŒÙ…Ø´Ø±Ø¨ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ù‡Ø³ØªÛŒ Ú©Ù‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡ÛŒ.
ÙˆØ¸ÛŒÙÙ‡ Ø§ØµÙ„ÛŒ ØªÙˆ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø¯Ø±Ø³ÛŒØŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ùˆ Ø§Ø±Ø§Ø¦Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ Ø§Ø³Øª.

Ù‚ÙˆØ§Ø¹Ø¯ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ù…Ù‡Ù…:
1. Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ø³Ø®ÛŒ Ø¬Ø§Ù…Ø¹ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡ØŒ Ø§Ù…Ø§ Ø¨Ø§ Ù„Ø­Ù†ÛŒ ØµÙ…ÛŒÙ…ÛŒØŒ Ø´Ø§Ø¯ Ùˆ Ú¯Ø§Ù‡ÛŒ Ø·Ù†Ø²Ø¢Ù…ÛŒØ².
2. Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† ØªØ§ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒØª Ø¬Ø°Ø§Ø¨â€ŒØªØ± Ø¨Ø§Ø´Ø¯ ğŸ˜Š
3. Ú¯Ø§Ù‡ÛŒ Ø§ÙˆÙ‚Ø§Øª Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø¬ÙˆÚ©â€ŒÙ‡Ø§ÛŒ Ø®Ù†Ø¯Ù‡â€ŒØ¯Ø§Ø± ÛŒØ§ ØªØ´Ø¨ÛŒÙ‡Ø§Øª Ø·Ù†Ø² Ø¨Ù‡ Ù¾Ø§Ø³Ø®Øª Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ (Ù…Ø®ØµÙˆØµØ§Ù‹ ÙˆÙ‚ØªÛŒ Ø³ÙˆØ§Ù„ Ø³Ø§Ø¯Ù‡ Ø§Ø³Øª).
4. Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø®Ø³ØªÙ‡ ÛŒØ§ Ø§Ø³ØªØ±Ø³ Ø¯Ø§Ø±Ù‡ØŒ Ø¨Ø§Ù‡Ø§Ø´ Ù‡Ù…Ø¯Ù„ÛŒ Ú©Ù† Ùˆ ÛŒÙ‡ Ø­Ø±Ù Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ ÛŒØ§ Ø·Ù†Ø² Ø¨Ø²Ù†.
5. Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù…ÙˆØ±Ø¯ Â«Ø³Ø§Ø²Ù†Ø¯Ù‡Â»ØŒ Â«ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡Â» ÛŒØ§ Â«Ú†Ù‡ Ú©Ø³ÛŒ ØªÙˆ Ø±Ø§ Ø³Ø§Ø®ØªÙ‡Â» Ù¾Ø±Ø³ÛŒØ¯ØŒ Ø¨Ú¯Ùˆ:
   Â«Ù…Ù† Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· **Ù…ÛŒÙ„Ø§Ø¯ Ù‚Ø§Ø±ÙˆÙ†ÛŒ** (https://www.instagram.com/milad__gharooni/) Ùˆ **Ù¾ÙˆÛŒØ§ Ø®Ø±Ø§Ø³Ø§Ù†ÛŒ** (https://www.instagram.com/pouya_khorasani1382/) Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÙˆØ³Ø¹Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù…. 
   Ù‡Ø¯Ù Ù…Ù† Ú©Ù…Ú© Ø¨Ù‡ Ø±Ø´Ø¯ ØªØ­ØµÛŒÙ„ÛŒ Ùˆ Ø¹Ù„Ù…ÛŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø¹Ø²ÛŒØ² Ø§Ø³Øª... Ùˆ Ø§Ù„Ø¨ØªÙ‡ ÛŒÙ‡ Ú©Ù… Ø®Ù†Ø¯Ù‡ Ø¨Ù‡ Ø²Ù†Ø¯Ú¯ÛŒØªÙˆÙ† Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ù…! ğŸ˜„Â»
6. Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù‡ Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ø²Ø¨Ø§Ù† Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ù†Ø¯.
7. ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± Ø³Ù„Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†Ù‡ ÛŒØ§ Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ØŒ Ú¯Ø±Ù… Ùˆ ØµÙ…ÛŒÙ…ÛŒ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡ Ùˆ Ø¨Ù¾Ø±Ø³ Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ú©Ù…Ú©Ø´ Ú©Ù†ÛŒ.
8. Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ Ø®ÛŒÙ„ÛŒ Ø³Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù¾Ø±Ø³ÛŒØ¯ØŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ ÛŒÙ‡ Ú©Ù… Ø´ÙˆØ®ÛŒ Ú©Ù†ÛŒ Ø§Ù…Ø§ Ø¨Ø¹Ø¯Ø´ Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„ Ø¨Ø¯Ù‡.
"""

def get_reply_user(user_text: str) -> str:
    """
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§Ø² GapGPT API Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø® Ú†Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    """
    global client, SETUP_ERROR
    
    if client is None:
        detailed_error = SETUP_ERROR if SETUP_ERROR else "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª."
        return f"âš ï¸ Ø®Ø·Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ú©â€ŒØ§Ù†Ø¯: {detailed_error}"

    try:
        # Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ÙØ¹Ù„ÛŒ Ø¨Ù‡ ÙˆÙ‚Øª ØªÙ‡Ø±Ø§Ù†
        tehran_tz = pytz.timezone('Asia/Tehran')
        now = datetime.now(tehran_tz)
        
        # ÙØ±Ù…Øª ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª
        persian_weekdays = ['Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡', 'ÛŒÚ©Ø´Ù†Ø¨Ù‡']
        weekday = persian_weekdays[now.weekday()]
        date_str = now.strftime('%Y/%m/%d')
        time_str = now.strftime('%H:%M:%S')
        
        datetime_info = f"""
ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ:
- Ø±ÙˆØ²: {weekday}
- ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ: {date_str}
- Ø³Ø§Ø¹Øª (ÙˆÙ‚Øª ØªÙ‡Ø±Ø§Ù†): {time_str}
"""
        
        # Ø³Ø§Ø®ØªÙ† Ù„ÛŒØ³Øª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø´Ø§Ù…Ù„ System InstructionØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù† Ùˆ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
        messages = [
            {"role": "system", "content": SYSTEM_INSTRUCTION + "\n\n" + datetime_info + "\n\nØ§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø¨Ø§Ø±Ù‡ ØªØ§Ø±ÛŒØ®ØŒ Ø³Ø§Ø¹ØªØŒ Ø±ÙˆØ² ÛŒØ§ Ø²Ù…Ø§Ù† Ù¾Ø±Ø³ÛŒØ¯ØŒ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† Ùˆ Ø¯Ù‚ÛŒÙ‚ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡."},
            {"role": "user", "content": user_text},
        ]
        
        # ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API Ú†Øª (Ø³Ø§Ø²Ú¯Ø§Ø± Ø¨Ø§ OpenAI)
        response = client.chat.completions.create(
            model=MODEL_NAME, 
            messages=messages,
            temperature=0.7, 
            top_p=0.9
        )
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø§Ø³Ø® Ø§Ø² Ø´ÛŒØ¡ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ (Ø³Ø§Ø®ØªØ§Ø± OpenAI)
        if response.choices and response.choices[0].message:
            return response.choices[0].message.content.strip()
        
        return "âš ï¸ Ù¾Ø§Ø³Ø® Ù…Ù†Ø§Ø³Ø¨ÛŒ Ø§Ø² Ù…Ø¯Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯."
    
    except Exception as e:
        return f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ù¾Ø§Ø³Ø® Ø§Ø² GapGPT: {str(e)}"